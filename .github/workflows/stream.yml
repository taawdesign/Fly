name: Build and Stream

on: workflow_dispatch  # Allows you to trigger it manually

jobs:
  build-and-stream:
    runs-on: macos-13 # Uses a Mac runner
    
    steps:
      - uses: actions/checkout@v3
      
      # 1. Build the App for the SIMULATOR
      - name: Build for Simulator
        run: |
          xcodebuild build \
            -scheme "YourAppScheme" \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 14' \
            -configuration Debug \
            -derivedDataPath build
            
      # 2. Zip the .app bundle (Appetize requires a zip)
      - name: Zip the Build
        run: |
          cd build/Build/Products/Debug-iphonesimulator/
          zip -r app_build.zip YourAppName.app
          
      # 3. Upload to Appetize.io
      - name: Upload to Streaming Server
        id: upload_step
        run: |
          response=$(curl --request POST https://api.appetize.io/v1/apps/your_public_key_if_updating_existing \
            --header "Authorization: Basic ${{ secrets.APPETIZE_TOKEN }}" \
            --header 'Content-Type: application/json' \
            --data-raw '{ "url": "DIRECT_UPLOAD", "platform": "ios" }' \
            -F "file=@build/Build/Products/Debug-iphonesimulator/app_build.zip")
            
          # Extract the Public Key URL from the JSON response
          # (In a real script, you would parse the JSON properly to get the 'publicKeys')
          echo "App uploaded! View it here: https://appetize.io/app/YOUR_PUBLIC_KEY"
