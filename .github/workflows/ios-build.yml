name: iOS Build
on:
  workflow_dispatch:
    inputs:
      ref:
        default: "main"
jobs:
  build:
    permissions: write-all
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install XcodeGen
        run: brew install xcodegen
        
      - name: Generate Project
        run: xcodegen generate
        
      - name: Build Archive
        run: |
          xcodebuild archive \
            -project MARK.xcodeproj \
            -scheme MARK \
            -destination "generic/platform=iOS" \
            -archivePath build/MARK.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
            
      - name: Export IPA
        run: |
          mkdir -p build/Payload
          mv build/MARK.xcarchive/Products/Applications/MARK.app build/Payload/
          cd build
          zip -r MARK.ipa Payload
          
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_id }}
          files: build/MARK.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}