name: Streamer

on:
  workflow_dispatch:
    inputs:
      file_name:
        description: 'Swift file to build'
        required: true
        type: string

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create SwiftUI App Project
        run: |
          mkdir -p BuildApp
          
          if [ -f "Sources/${{ github.event.inputs.file_name }}" ]; then
            cat "Sources/${{ github.event.inputs.file_name }}" | awk '
              /@main/ { skip=1; next }
              /struct [A-Za-z]+App.*:.*App/ { skip=1; brace=1; next }
              skip && /{/ { brace++ }
              skip && /}/ { brace--; if(brace<=0) { skip=0 }; next }
              !skip { print }
            ' > BuildApp/ContentView.swift
            
            echo "=== Processed ContentView.swift ==="
            cat BuildApp/ContentView.swift
          else
            echo "Source file not found, creating default"
            cat > BuildApp/ContentView.swift << 'SWIFT'
          import SwiftUI
          struct ContentView: View {
              var body: some View {
                  Text("Hello World")
              }
          }
          SWIFT
          fi
          
          cat > BuildApp/App.swift << 'SWIFT'
          import SwiftUI
          @main
          struct BuildAppApp: App {
              var body: some Scene {
                  WindowGroup {
                      ContentView()
                  }
              }
          }
          SWIFT
          
          cat > BuildApp/Info.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>BuildApp</string>
              <key>CFBundleIdentifier</key>
              <string>com.swiftide.app</string>
              <key>CFBundleName</key>
              <string>BuildApp</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
              <key>UILaunchScreen</key>
              <dict/>
          </dict>
          </plist>
          PLIST

      - name: Build for iOS Simulator
        run: |
          cd BuildApp
          SDK_PATH=$(xcrun --sdk iphonesimulator --show-sdk-path)
          xcrun swiftc \
            -sdk "$SDK_PATH" \
            -target arm64-apple-ios16.0-simulator \
            -parse-as-library \
            -emit-executable \
            -o BuildApp \
            App.swift \
            ContentView.swift
          echo "Build done"
            
      - name: Create app bundle
        run: |
          mkdir -p BuildApp.app
          mv BuildApp/BuildApp BuildApp.app/BuildApp
          cp BuildApp/Info.plist BuildApp.app/Info.plist
          ls -la BuildApp.app/
          
      - name: Upload to Appetize
        env:
          APPETIZE_TOKEN: ${{ secrets.APPETIZE_TOKEN }}
        run: |
          zip -r app.zip BuildApp.app
          echo "Uploading..."
          curl -s "https://api.appetize.io/v1/apps/zvc4brtsspoktczlbrs54s3mhi?token=$APPETIZE_TOKEN" \
            -F "file=@app.zip" \
            -F "platform=ios"
          echo ""
          echo "Done"
